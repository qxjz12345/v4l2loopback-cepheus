name: Build v4l2loopback for Xiaomi 9

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential bc bison flex libssl-dev libelf-dev
        sudo apt-get install -y gcc-aarch64-linux-gnu
        # Fix yylloc multiple definition error in dtc
        sudo apt-get install -y gcc-9 g++-9
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-9 100
        sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-9 100
        
    - name: Download Xiaomi kernel source
      run: |
        git clone --depth 1 --branch cepheus-q-oss https://github.com/MiCode/Xiaomi_Kernel_OpenSource.git kernel
        
    - name: Download v4l2loopback
      run: |
        git clone --depth 1 https://github.com/umlaeute/v4l2loopback.git
        
    - name: Find defconfig
      run: |
        echo "Looking for cepheus defconfig..."
        find kernel -name "*cepheus*" -o -name "*defconfig" | grep -i cepheus || true
        ls kernel/arch/arm64/configs/ | grep -i cepheus || true
        
    - name: Prepare kernel
      run: |
        cd kernel
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        # Try different possible defconfig names
        if [ -f arch/arm64/configs/cepheus_defconfig ]; then
          make ARCH=arm64 cepheus_defconfig
        elif [ -f arch/arm64/configs/cepheus_user_defconfig ]; then
          make ARCH=arm64 cepheus_user_defconfig
        elif [ -f arch/arm64/configs/vendor/cepheus_defconfig ]; then
          make ARCH=arm64 vendor/cepheus_defconfig
        else
          echo "Available defconfigs:"
          ls arch/arm64/configs/
          # Use a generic defconfig and modify for modules
          make ARCH=arm64 defconfig
        fi
        # Enable modules support
        scripts/config --enable CONFIG_MODULES
        scripts/config --enable CONFIG_MODULE_UNLOAD
        scripts/config --enable CONFIG_VIDEO_V4L2
        scripts/config --enable CONFIG_MEDIA_SUPPORT
        make ARCH=arm64 olddefconfig
        make ARCH=arm64 prepare
        make ARCH=arm64 modules_prepare
        
    - name: Fix kernel Python scripts
      run: |
        cd kernel
        # Use python3
        sed -i 's|#!/usr/bin/env python$|#!/usr/bin/env python3|g' scripts/gcc-wrapper.py
        # Fix Python 2 "print >> sys.stderr, msg," (trailing comma = no newline)
        # -> Python 3 "print(msg, file=sys.stderr, end='')"
        sed -i 's/print\s*>>\s*sys\.stderr\s*,\s*\(.*\),$/print(\1, file=sys.stderr, end="")/g' scripts/gcc-wrapper.py
        # Fix Python 2 "print >> sys.stderr, msg" (no trailing comma)
        # -> Python 3 "print(msg, file=sys.stderr)"
        sed -i 's/print\s*>>\s*sys\.stderr\s*,\s*\(.*[^,]\)$/print(\1, file=sys.stderr)/g' scripts/gcc-wrapper.py
        # Show the fixed file for debugging
        echo "=== Fixed gcc-wrapper.py ==="
        cat scripts/gcc-wrapper.py
        echo "==========================="
        # Disable module signing
        scripts/config --disable CONFIG_MODULE_SIG
        scripts/config --disable CONFIG_MODULE_SIG_ALL
        scripts/config --set-str CONFIG_MODULE_SIG_KEY ""
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig
        
    - name: Build v4l2loopback module
      run: |
        cd v4l2loopback
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        make KERNEL_DIR=../kernel ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- CONFIG_MODULE_SIG=n
        
    - name: Upload module
      uses: actions/upload-artifact@v4
      with:
        name: v4l2loopback-cepheus
        path: v4l2loopback/*.ko
